1:"$Sreact.fragment"
2:I[909,["144","static/chunks/144-6ef9499ac178c5dc.js","245","static/chunks/245-30e455921c0f8f22.js","177","static/chunks/app/layout-a6c5d823159daef4.js"],"default"]
3:I[7468,["144","static/chunks/144-6ef9499ac178c5dc.js","245","static/chunks/245-30e455921c0f8f22.js","177","static/chunks/app/layout-a6c5d823159daef4.js"],"ClientThemeProvider"]
4:I[1886,["144","static/chunks/144-6ef9499ac178c5dc.js","245","static/chunks/245-30e455921c0f8f22.js","177","static/chunks/app/layout-a6c5d823159daef4.js"],"default"]
5:I[8412,["144","static/chunks/144-6ef9499ac178c5dc.js","245","static/chunks/245-30e455921c0f8f22.js","177","static/chunks/app/layout-a6c5d823159daef4.js"],"default"]
6:I[5244,[],""]
7:I[3866,[],""]
8:I[3620,["144","static/chunks/144-6ef9499ac178c5dc.js","245","static/chunks/245-30e455921c0f8f22.js","177","static/chunks/app/layout-a6c5d823159daef4.js"],"default"]
a:I[6213,[],"OutletBoundary"]
c:I[6213,[],"MetadataBoundary"]
e:I[6213,[],"ViewportBoundary"]
10:I[4835,[],""]
:HL["/cae-theory/_next/static/css/fd89b796fb218fbf.css","style"]
0:{"P":null,"b":"klibeS21nDp3EOmRvX-vz","p":"/cae-theory","c":["","iteration3","concurrency"],"i":false,"f":[[["",{"children":[["slug","iteration3/concurrency","oc"],{"children":["__PAGE__",{}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/cae-theory/_next/static/css/fd89b796fb218fbf.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$L2",null,{"children":["$","$L3",null,{"children":["$","html",null,{"children":[["$","head",null,{"children":[["$","title",null,{"children":"CAE Course"}],["$","link",null,{"rel":"icon","type":"image/svg+xml","href":"/cae-theory/favicon.svg"}]]}],["$","body",null,{"children":[["$","header",null,{"children":["$","$L4",null,{"siteMetaData":{"version":"","title":"CAE","description":"siteDescription","url":"siteURL","youtubeUrl":"youtubeUrl","authorEmail":"authorEmail","facebookUrl":"facebookUrl","instagramUrl":"instagramUrl","menuLinks":[{"name":"Home","link":"/"},{"name":"Intro","link":"/intro"},{"name":"Qualité","link":"","subMenu":[{"name":"Qualité générale","link":"/quality/general"},{"name":"Qualité du frontend","link":"/quality/frontend"},{"name":"Qualité de l'API","link":"/quality/api"},{"name":"Intégration Continue","link":"/quality/ci"},{"name":"Tests e2e","link":"/quality/e2e"}]},{"name":"Itération 2","link":"","subMenu":[{"name":"Gestion des environnements","link":"/iteration2/general"},{"name":"Conteneurisation","link":"/iteration2/containerization"},{"name":"Déploiement","link":"/iteration2/deployment"},{"name":"Gestion des images","link":"/iteration2/images"}]},{"name":"Itération 3","link":"","subMenu":[{"name":"Gestion de la production","link":"/iteration3/production"},{"name":"Gestion des logs & exceptions","link":"/iteration3/logs"},{"name":"Gestion de la concurrence","link":"/iteration3/concurrency"}]},{"name":"About","link":"/about"}]}}]}],["$","$L5",null,{"sx":{"padding":"1rem","wordWrap":"break-word"},"children":["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[],[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]]],"forbidden":"$undefined","unauthorized":"$undefined"}]}],["$","$L8",null,{}]]}]]}]}]}]]}],{"children":[["slug","iteration3/concurrency","oc"],["$","$1","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","$0:f:0:1:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L9",null,["$","$La",null,{"children":"$Lb"}]]}],{},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","V31JR6GPdldEGee5V3HMG",{"children":[["$","$Lc",null,{"children":"$Ld"}],["$","$Le",null,{"children":"$Lf"}],null]}]]}],false]],"m":"$undefined","G":["$10","$undefined"],"s":false,"S":true}
11:I[3508,["144","static/chunks/144-6ef9499ac178c5dc.js","830","static/chunks/830-d07b37352b41f989.js","340","static/chunks/app/%5B%5B...slug%5D%5D/page-e6ba2748711f75c3.js"],"default"]
12:I[283,["144","static/chunks/144-6ef9499ac178c5dc.js","830","static/chunks/830-d07b37352b41f989.js","340","static/chunks/app/%5B%5B...slug%5D%5D/page-e6ba2748711f75c3.js"],"default"]
13:I[6656,["144","static/chunks/144-6ef9499ac178c5dc.js","830","static/chunks/830-d07b37352b41f989.js","340","static/chunks/app/%5B%5B...slug%5D%5D/page-e6ba2748711f75c3.js"],"default"]
14:I[8173,["144","static/chunks/144-6ef9499ac178c5dc.js","830","static/chunks/830-d07b37352b41f989.js","340","static/chunks/app/%5B%5B...slug%5D%5D/page-e6ba2748711f75c3.js"],""]
15:I[4754,["144","static/chunks/144-6ef9499ac178c5dc.js","830","static/chunks/830-d07b37352b41f989.js","340","static/chunks/app/%5B%5B...slug%5D%5D/page-e6ba2748711f75c3.js"],"default"]
16:I[2738,["144","static/chunks/144-6ef9499ac178c5dc.js","830","static/chunks/830-d07b37352b41f989.js","340","static/chunks/app/%5B%5B...slug%5D%5D/page-e6ba2748711f75c3.js"],"default"]
9:[["$","$L11",null,{"children":[["$","$L12",null,{"aria-label":"breadcrumb","children":[["$","$L13",null,{"href":"/","underline":"hover","color":"inherit","component":"$14","children":" CAE "}],["$","$L13",null,{"href":"/iteration3","underline":"hover","color":"inherit","component":"$14","children":" Itération 3 "}],["$","$L13",null,{"href":"#","underline":"hover","color":"inherit","component":"$14","children":" Gestion de la concurrence "}]]}],["$","$L15",null,{"component":"div","sx":{"paddingTop":0,"paddingBottom":0},"children":["$","$L13",null,{"href":"#pourquoi_gerer_la_concurrence","underline":"hover","color":"inherit","component":"$14","children":["$","$L16",null,{"primary":" Pourquoi gérer la concurrence ? "}]}]}],["$","$L15",null,{"component":"div","sx":{"paddingTop":0,"paddingBottom":0},"children":["$","$L13",null,{"href":"#comment_gerer_la_concurrence","underline":"hover","color":"inherit","component":"$14","children":["$","$L16",null,{"primary":" Comment gérer la concurrence ? "}]}]}],["$","$L15",null,{"component":"div","sx":{"paddingTop":0,"paddingBottom":0},"children":["$","$L13",null,{"href":"#optimistic_locking_dans_spring_boot","underline":"hover","color":"inherit","component":"$14","children":["$","$L16",null,{"primary":" Optimistic Locking dans Spring Boot "}]}]}],["$","$L15",null,{"component":"div","sx":{"paddingTop":0,"paddingBottom":0},"children":["$","$L13",null,{"href":"#pessimistic_locking_dans_spring_boot","underline":"hover","color":"inherit","component":"$14","children":["$","$L16",null,{"primary":" Pessimistic Locking dans Spring Boot "}]}]}],["$","$L15",null,{"component":"div","sx":{"paddingTop":0,"paddingBottom":0},"children":["$","$L13",null,{"href":"#comment_gerer_des_transactions_dans_spring_boot","underline":"hover","color":"inherit","component":"$14","children":["$","$L16",null,{"primary":" Comment gérer des transactions dans Spring Boot ? "}]}]}]]}],"\n",["$","h1",null,{"children":["$","a",null,{"id":"pourquoi_gerer_la_concurrence","children":" Pourquoi gérer la concurrence ? "}]}],"\n",["$","p",null,{"children":"La concurrence est un sujet important en informatique. En effet, de nombreux problèmes peuvent survenir si la concurrence n'est pas gérée correctement. Par exemple, si deux processus essaient de modifier la même donnée en même temps, il peut y avoir des problèmes de cohérence des données."}],"\n",["$","p",null,{"children":"Prenons l'exemple d'une application où l'on gère un stock de produits. Si deux utilisateurs essaient de modifier la quantité d'un produit en même temps, il peut y avoir des problèmes de cohérence des données. Par exemple, si un utilisateur essaie d'ajouter 5 unités à la quantité d'un produit, et qu'un autre utilisateur essaie de retirer 3 unités du même produit en même temps, il peut y avoir des problèmes de cohérence des données."}],"\n",["$","p",null,{"children":["NB : La concurrence pourrait entraîner des problèmes de performance si elle n'est pas gérée correctement. Par exemple, si plusieurs processus essaient d'accéder à la même ressource en même temps, il peut y avoir des problèmes de latence et de ralentissement. Néanmoins, nous ne devons généralement pas gérer ce type de problème car cela est automatiquement traité par les frameworks que nous utilisons. En effet, en cas de multiples requêtes sur une même ressource, le framework Spring Boot gère cela en créant un pool de threads pour traiter les requêtes. Comment ça fonctionne ?",["$","br",null,{}],"\n","Lorsqu'une requête HTTP arrive, un thread est extrait du pool pour traiter cette requête.",["$","br",null,{}],"\n","Une fois la requête traitée, le thread est remis dans le pool pour être réutilisé.",["$","br",null,{}],"\n","Cela permet de limiter le nombre de threads actifs et d'éviter de créer un nouveau thread pour chaque requête, ce qui serait coûteux en termes de performances."]}],"\n",["$","h1",null,{"children":["$","a",null,{"id":"comment_gerer_la_concurrence","children":" Comment gérer la concurrence ? "}]}],"\n",["$","h2",null,{"children":"Introduction"}],"\n",["$","p",null,{"children":"Il existe plusieurs façons de gérer la concurrence en informatique. Voici quelques-unes des techniques les plus courantes :"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Optimistic Locking"}]," : Cette technique consiste à vérifier si la donnée a été modifiée par un autre processus avant de la modifier. Si la donnée a été modifiée, une exception est levée et le processus doit gérer cette exception."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Pessimistic Locking"}]," : Cette technique consiste à verrouiller la donnée avant de la modifier. Cela garantit qu'aucun autre processus ne peut modifier la donnée tant que le verrou n'est pas libéré."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Transactions"}]," : Les transactions sont un moyen de regrouper plusieurs opérations sur une base de données en une seule unité logique. Cela garantit que toutes les opérations sont exécutées de manière atomique, c'est-à-dire que toutes les opérations sont exécutées ou aucune opération n'est exécutée. Les transactions sont particulièrement utiles pour garantir la cohérence des données dans des scénarios de concurrence, sans pour autant régler les problèmes de concurrence en eux-mêmes."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Vérous distribués"}]," : Les verrous distribués sont des verrous qui peuvent être utilisés pour coordonner l'accès à une ressource partagée entre plusieurs processus. Redis peut être utilisé pour ce genre d'applications. Des verrous peuvent être utilisés pour garantir que seuls un certain nombre de processus peuvent accéder à la ressource en même temps. Cela est particulièrement utile dans des architectures distribuées, type microservices, où plusieurs instances doivent gérer une ressource partagée. Nous n'aborderons pas ce sujet dans ce cours, car notre application n'est pas distribuée."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"File de messages"}]," : Une file de messages (comme RabbitMQ ou Kafka) peut être utilisée pour gérer la concurrence. Les messages sont envoyés à une file, puis traités par un ou plusieurs consommateurs. Cela permet de gérer la concurrence en séparant la production de la consommation de messages. Ce type de solution est particulièrement utile dans des architectures distribuées, où plusieurs instances doivent traiter des messages en parallèle. Nous n'aborderons pas ce sujet dans ce cours."]}],"\n"]}],"\n",["$","h1",null,{"children":["$","a",null,{"id":"optimistic_locking_dans_spring_boot","children":" Optimistic Locking dans Spring Boot "}]}],"\n",["$","h2",null,{"children":"Introduction"}],"\n",["$","p",null,{"children":"L'optimistic locking repose sur l'idée que les conflits sont rares. Avant de mettre à jour une donnée, on vérifie si elle a été modifiée par un autre processus en utilisant un champ de version."}],"\n",["$","p",null,{"children":"L'optimistic locking est idéal pour les scénarios où les conflits sont peu fréquents, comme la mise à jour d'un nom de produit ou la mise à jour d'une quantité en stock, lorsque le stock est modifiable par un nombre limité d'utilisateurs."}],"\n",["$","p",null,{"children":"L'intérêt de l'optimistic locking est qu'il n'y a pas de verrouillage de la ressource, ce qui permet à plusieurs processus de lire la ressource en même temps. Cela améliore les performances de l'application. Cependant, si un conflit survient, il faut gérer l'exception levée par la base de données."}],"\n",["$","h2",null,{"children":"Bases pour l'optimistic locking"}],"\n",["$","p",null,{"children":"Voici un exemple d'optimistic locking en Java avec JPA :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Entity"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"Product"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Id"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@GeneratedValue"}],["$","span",null,{"className":"token punctuation","children":"("}],"strategy ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token class-name","children":"GenerationType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"IDENTITY"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," name",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"9","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," quantity",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":"\n"}],["$","span",null,{"className":"code-line line-number highlight-line","line":"11","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Version"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," version",["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token comment","children":"// Champ utilisé pour l'optimistic locking"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"14","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"15","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"16","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"17","children":[["$","span",null,{"className":"token comment","children":"// Partie du service pour mettre à jour le stock d'un produit"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"18","children":"\n"}],["$","span",null,{"className":"code-line line-number highlight-line","line":"19","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Transactional"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"20","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"void"}]," ",["$","span",null,{"className":"token function","children":"updateStock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Long"}]," productId",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," quantityToRemove",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"21","children":["    ",["$","span",null,{"className":"token class-name","children":"Product"}]," product ",["$","span",null,{"className":"token operator","children":"="}]," productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findById"}],["$","span",null,{"className":"token punctuation","children":"("}],"productId",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"22","children":["            ",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"orElseThrow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"->"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Produit non trouvé\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"23","children":"    \n"}],["$","span",null,{"className":"code-line line-number","line":"24","children":["    ",["$","span",null,{"className":"token keyword","children":"if"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"<"}]," quantityToRemove",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"25","children":["        ",["$","span",null,{"className":"token keyword","children":"throw"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Stock insuffisant\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"26","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"27","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"28","children":["    product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"-"}]," quantityToRemove",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"29","children":["    productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"save"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token comment","children":"// Vérifie automatiquement la version"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"30","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["Dans cet exemple, le champ ",["$","strong",null,{"children":["$","code",null,{"children":"version"}]}]," est utilisé pour l'optimistic locking. Lorsque la méthode ",["$","code",null,{"children":"save"}]," est appelée, JPA vérifie automatiquement si la version de l'entité en base de données correspond à la version de l'entité en mémoire. Si ce n'est pas le cas, une exception ",["$","strong",null,{"children":["$","code",null,{"children":"OptimisticLockException"}]}]," est levée."]}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":["$","code",null,{"children":"@Transactional"}]}]," : Cette annotation permet de définir une méthode comme transactionnelle. Cela signifie que toutes les opérations effectuées dans cette méthode seront regroupées en une seule transaction. Ici, comme il n'y a qu'une seule opération (la mise à jour du stock), l'annotation ",["$","strong",null,{"children":["$","code",null,{"children":"@Transactional"}]}]," n'est pas strictement nécessaire, mais elle est recommandée pour des raisons de clarté.",["$","br",null,{}],"\n","En effet, si vous ajoutez d'autres opérations de modification dans cette méthode, elles seront automatiquement incluses dans la transaction."]}],"\n",["$","p",null,{"children":"Ici l'on vérifie la version de l'entité en base de données au moment de la sauvegarde. Cela est suffisant pour gérer les conflits dans le cadre d'une opération transactionnelle unique, si l'on imaginait que deux utilisateurs essaient de modifier la quantité d'un produit en même temps."}],"\n",["$","blockquote",null,{"children":["\n",["$","p",null,{"children":["Attention : Le code donné pour l'optimistic locking dans l'exemple ci-dessus fonctionne bien dans le cadre d'une opération transactionnelle unique, où la version est vérifiée au moment de l'exécution de la méthode ",["$","strong",null,{"children":["$","code",null,{"children":"updateStock"}]}],". Cependant, dans le contexte d'une API RESTful, où les appels sont effectués par des clients distincts (par exemple, deux requêtes HTTP séparées), ce code ne couvre pas le cas où la version doit être vérifiée entre deux requêtes clientes, lorsqu'il y a une opération de lecture suivie d'une opération de mise à jour. Nous verrons comment gérer ce cas dans la section suivante."]}],"\n"]}],"\n",["$","h2",null,{"children":"Optimistic locking dans une API RESTful avec lecture suivie d'une mise à jour"}],"\n",["$","h3",null,{"children":"Introduction"}],"\n",["$","p",null,{"children":["Dans une API RESTful, il est courant que le client effectue une requête ",["$","strong",null,{"children":["$","code",null,{"children":"GET"}]}]," pour récupérer une ressource, puis une requête ",["$","strong",null,{"children":["$","code",null,{"children":"PUT"}]}]," ou ",["$","strong",null,{"children":["$","code",null,{"children":"PATCH"}]}]," pour la mettre à jour. Dans ce cas, il est nécessaire de vérifier que la version de la ressource n'a pas changé entre les deux requêtes."]}],"\n",["$","p",null,{"children":"Par exemple, si l'on veut assurer que deux clients ne modifient pas en même temps le nom d'un produit, on doit vérifier que la version du produit n'a pas changé entre la lecture et la mise à jour. Car si un client lit le produit, puis un autre client modifie le produit, le premier client pourrait écraser les modifications du second client sans le savoir."}],"\n",["$","h3",null,{"children":"Exemple concret"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["Ajouter le champ ",["$","strong",null,{"children":["$","code",null,{"children":"@Version"}]}]," dans l'entité",["$","br",null,{}],"\n","Le champ ",["$","strong",null,{"children":["$","code",null,{"children":"@Version"}]}]," est utilisé pour gérer l'optimistic locking. JPA vérifie automatiquement ce champ lors de la sauvegarde."]}],"\n"]}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Entity"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"Product"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Id"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@GeneratedValue"}],["$","span",null,{"className":"token punctuation","children":"("}],"strategy ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token class-name","children":"GenerationType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"IDENTITY"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," name",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"9","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," quantity",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":"\n"}],["$","span",null,{"className":"code-line line-number highlight-line","line":"11","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Version"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," version",["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token comment","children":"// Champ utilisé pour l'optimistic locking"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"14","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"15","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","ol",null,{"start":"2","children":["\n",["$","li",null,{"children":["Lecture de la ressource avec la version (GET)",["$","br",null,{}],"\n","Lorsqu'un client récupère une ressource, incluez la version dans la réponse pour qu'il puisse l'utiliser lors de la mise à jour."]}],"\n"]}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@GetMapping"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"/products/{id}\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"ProductDTO"}]," ",["$","span",null,{"className":"token function","children":"getProduct"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token annotation punctuation","children":"@PathVariable"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":["    ",["$","span",null,{"className":"token class-name","children":"Product"}]," product ",["$","span",null,{"className":"token operator","children":"="}]," productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findById"}],["$","span",null,{"className":"token punctuation","children":"("}],"id",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":["            ",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"orElseThrow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"->"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Produit non trouvé\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"6","children":["    ",["$","span",null,{"className":"token keyword","children":"return"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"ProductDTO"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getId"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}]," product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getName"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}]," product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}]," product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getVersion"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"7","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"9","children":[["$","span",null,{"className":"token comment","children":"// Code pour l'opération de lecture d'un produit"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":[["$","span",null,{"className":"token annotation punctuation","children":"@GetMapping"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"/products/{id}\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"ProductDTO"}]," ",["$","span",null,{"className":"token function","children":"getProduct"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token annotation punctuation","children":"@PathVariable"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":["    ",["$","span",null,{"className":"token class-name","children":"Product"}]," product ",["$","span",null,{"className":"token operator","children":"="}]," productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findById"}],["$","span",null,{"className":"token punctuation","children":"("}],"id",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":["            ",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"orElseThrow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"->"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Produit non trouvé\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":"\n"}],["$","span",null,{"className":"code-line line-number highlight-line","line":"15","children":["    ",["$","span",null,{"className":"token keyword","children":"return"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"ProductDTO"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getId"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}]," product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getName"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}]," product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}]," product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getVersion"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"16","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","ol",null,{"start":"3","children":["\n",["$","li",null,{"children":["Mise à jour de la ressource avec vérification de la version (PUT)",["$","br",null,{}],"\n","Lors de la mise à jour, le client doit inclure la version qu'il a reçue dans la requête. Si cette version ne correspond pas à la version actuelle de la ressource, on décide de lever une exception ",["$","strong",null,{"children":["$","code",null,{"children":"OptimisticLockException"}]}]," seulement si le nom du produit a été mis à jour.",["$","br",null,{}],"\n","De plus, JPA effectue automatiquement la vérification de la version si le champ ",["$","strong",null,{"children":["$","code",null,{"children":"@Version"}]}]," est présent dans l'entité et que vous utilisez une méthode comme ",["$","strong",null,{"children":["$","code",null,{"children":"save()"}]}]," pour persister l'entité. Lorsque vous appelez ",["$","strong",null,{"children":["$","code",null,{"children":"productRepository.save(product)"}]}],", JPA compare la version de l'entité en mémoire avec celle en base de données.",["$","br",null,{}],"\n","Si elles ne correspondent pas (par exemple, si un autre client a modifié la ressource entre-temps), une exception ",["$","strong",null,{"children":["$","code",null,{"children":"OptimisticLockException"}]}]," est aussi levée."]}],"\n"]}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token comment","children":"// Code pour l'opération de mise à jour d'un produit"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Transactional"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":[["$","span",null,{"className":"token annotation punctuation","children":"@PutMapping"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"/products/{id}\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"ResponseEntity"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"Void"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token function","children":"updateProduct"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token annotation punctuation","children":"@PathVariable"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token annotation punctuation","children":"@RequestBody"}]," ",["$","span",null,{"className":"token class-name","children":"UpdateProductRequest"}]," request",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token class-name","children":"Product"}]," product ",["$","span",null,{"className":"token operator","children":"="}]," productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findById"}],["$","span",null,{"className":"token punctuation","children":"("}],"id",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":["            ",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"orElseThrow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"->"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Produit non trouvé\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"7","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"8","children":["    ",["$","span",null,{"className":"token keyword","children":"if"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"<"}]," request",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantityToRemove"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"9","children":["        ",["$","span",null,{"className":"token keyword","children":"throw"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Stock insuffisant\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"12","children":["    ",["$","span",null,{"className":"token comment","children":"// Vérification explicite de la version "}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"13","children":["    ",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"!"}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getVersion"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"equals"}],["$","span",null,{"className":"token punctuation","children":"("}],"request",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getVersion"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"14","children":["      ",["$","span",null,{"className":"token keyword","children":"if"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"!"}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getName"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"equals"}],["$","span",null,{"className":"token punctuation","children":"("}],"request",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getName"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"15","children":["        ",["$","span",null,{"className":"token keyword","children":"throw"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"OptimisticLockException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Conflit de version détecté lors du changement de nom\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"16","children":["      ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"17","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"18","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"19","children":["    ",["$","span",null,{"className":"token comment","children":"// Mise à jour du nom"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"20","children":["    product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setName"}],["$","span",null,{"className":"token punctuation","children":"("}],"request",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getName"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"21","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"22","children":["    ",["$","span",null,{"className":"token comment","children":"// Mise à jour de la quantité"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"23","children":["    product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"+"}]," request",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantityToRemove"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"24","children":["    productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"save"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"25","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"26","children":["    ",["$","span",null,{"className":"token keyword","children":"return"}]," ",["$","span",null,{"className":"token class-name","children":"ResponseEntity"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"noContent"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"build"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"27","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"28","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"29","children":[["$","span",null,{"className":"token comment","children":"// Code pour UpdateProductRequest"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"30","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"UpdateProductRequest"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"31","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," string name",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"32","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," quantityToRemove",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"33","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," version",["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token comment","children":"// Version reçue lors de la lecture"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"34","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"35","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"36","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","ol",null,{"start":"4","children":["\n",["$","li",null,{"children":"Gestion des conflits"}],"\n"]}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token annotation punctuation","children":"@ControllerAdvice"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"GlobalExceptionHandler"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@ExceptionHandler"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"OptimisticLockException"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token keyword","children":"class"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"ResponseEntity"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"String"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token function","children":"handleOptimisticLockException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"OptimisticLockException"}]," ex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["        ",["$","span",null,{"className":"token keyword","children":"return"}]," ",["$","span",null,{"className":"token class-name","children":"ResponseEntity"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"status"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"HttpStatus"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"CONFLICT"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"body"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Conflit de version détecté\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["En cas de conflit de version, le gestionnaire global d'exceptions renvoie une réponse ",["$","strong",null,{"children":["$","code",null,{"children":"409 Conflict"}]}]," au client."]}],"\n",["$","p",null,{"children":["Le client peut alors gérer ce cas en récupérant à nouveau la ressource, en affichant un message à l'utilisateur ou en effectuant une autre action appropriée.",["$","br",null,{}],"\n","Notamment, en cas de tentative de modification du nom du produit, le client peut afficher un message à l'utilisateur pour l'informer du conflit et lui demander de confirmer la modification."]}],"\n",["$","p",null,{"children":"Il faudrait bien sûr adapter ce code à votre application, en fonction de vos besoins et de votre architecture. Par exemple, vous pourriez ajouter un champs pour gérer la confirmation de la modification du nom du produit, ou ajouter des informations supplémentaires dans la réponse pour aider le client à gérer le conflit."}],"\n",["$","h2",null,{"children":"En savoir plus"}],"\n",["$","p",null,{"children":["Si vous souhaitez en savoir plus sur l'optimistic locking, vous pouvez consulter cet article : ",["$","a",null,{"href":"https://www.baeldung.com/jpa-optimistic-locking","children":"https://www.baeldung.com/jpa-optimistic-locking"}]]}],"\n",["$","h1",null,{"children":["$","a",null,{"id":"pessimistic_locking_dans_spring_boot","children":" Pessimistic Locking dans Spring Boot "}]}],"\n",["$","h2",null,{"children":"Introduction"}],"\n",["$","p",null,{"children":"Le pessimistic locking repose sur l'idée que les conflits sont fréquents. Avant de mettre à jour une donnée, on verrouille la ressource pour empêcher tout autre processus de la modifier."}],"\n",["$","p",null,{"children":"Le pessimistic locking est idéal pour les scénarios où les conflits sont fréquents, comme la mise à jour d'un stock de produits lorsque le stock peut être modifié par énormément d'utilisateurs en même temps."}],"\n",["$","h2",null,{"children":"Bases pour le pessimistic locking"}],"\n",["$","p",null,{"children":"Voici un exemple de pessimistic locking en Java avec JPA :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token comment","children":"// Partie du service pour mettre à jour le stock d'un produit"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"2","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Transactional"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"void"}]," ",["$","span",null,{"className":"token function","children":"updateStockWithPessimisticLock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Long"}]," productId",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," quantityToAdd",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":["    ",["$","span",null,{"className":"token class-name","children":"Product"}]," product ",["$","span",null,{"className":"token operator","children":"="}]," productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findByIdWithLock"}],["$","span",null,{"className":"token punctuation","children":"("}],"productId",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["            ",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"orElseThrow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"->"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Produit non trouvé\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"+"}]," quantityToAdd",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":["    productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"save"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"9","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"11","children":[["$","span",null,{"className":"token comment","children":"// Repository"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"13","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Repository"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"interface"}]," ",["$","span",null,{"className":"token class-name","children":"ProductRepository"}]," ",["$","span",null,{"className":"token keyword","children":"extends"}]," ",["$","span",null,{"className":"token class-name","children":"JpaRepository"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"Product"}],["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token class-name","children":"Long"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number highlight-line","line":"15","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Lock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"LockModeType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"PESSIMISTIC_WRITE"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"16","children":["    ",["$","span",null,{"className":"token class-name","children":"Optional"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"Product"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token function","children":"findById"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Long"}]," productId",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"17","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["Avec JPA, vous pouvez utiliser ",["$","strong",null,{"children":["$","code",null,{"children":"@Lock"}]}]," directement sur la méthode ",["$","strong",null,{"children":["$","code",null,{"children":"findById"}]}]," pour appliquer un verrou pessimiste sans avoir besoin d'une requête personnalisée."]}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":["$","code",null,{"children":"@Lock(LockModeType.PESSIMISTIC_WRITE)"}]}]," : Cette annotation permet d'appliquer un verrou pessimiste en écriture sur la ressource. Cela signifie que la ressource est verrouillée pour empêcher tout autre processus de la modifier."]}],"\n",["$","p",null,{"children":["Dans cet exemple, le verrou pessimiste est appliqué lors de la recherche du produit à mettre à jour. Cela garantit qu'aucun autre processus ne peut modifier le produit tant que le verrou n'est pas libéré. A quel moment le verrou est-il libéré ? Le verrou est généralement libéré à la fin de la transaction, c'est-à-dire lorsque la méthode annotée avec ",["$","strong",null,{"children":["$","code",null,{"children":"@Transactional"}]}]," se termine."]}],"\n",["$","p",null,{"children":"Que se passe-t-il si un autre processus essaie de lire ou de modifier la ressource verrouillée ? Imaginons que 10 utilisateurs essaient de mettre à jour le stock d'un produit en même temps. Le premier utilisateur obtient le verrou et met à jour le stock. Les 9 autres utilisateurs attendent que le verrou soit libéré. Une fois que le premier utilisateur a terminé, le verrou est libéré et un des 9 autres utilisateurs obtient le verrou et met à jour le stock. Les 8 autres utilisateurs attendent, et ainsi de suite."}],"\n",["$","h2",null,{"children":"Problème éventuel de performance"}],"\n",["$","p",null,{"children":"Le pessimistic locking peut entraîner des problèmes de performance si les verrous sont maintenus trop longtemps. Par exemple, si un utilisateur obtient un verrou et met à jour le stock, mais ne termine pas l'opération, le verrou est maintenu et les autres utilisateurs doivent attendre. Cela peut entraîner des problèmes de latence et de ralentissement."}],"\n",["$","p",null,{"children":["Heureusement, si une exception est levée, grâce à la transaction ",["$","strong",null,{"children":["$","code",null,{"children":"@Transactional"}]}],", le verrou est automatiquement libéré."]}],"\n",["$","p",null,{"children":["Pour éviter que les verrous ne soient maintenus trop longtemps, il est recommandé de limiter la durée des transactions en ajoutant un timeout. Par exemple, vous pouvez ajouter une annotation ",["$","strong",null,{"children":["$","code",null,{"children":"@Transactional(timeout = 10)"}]}]," pour limiter la durée de la transaction à 10 secondes. Si la transaction ne se termine pas dans les 10 secondes, une exception est levée et le verrou est libéré."]}],"\n",["$","p",null,{"children":["Comment s'appelle l'exception levée en cas de timeout ? L'exception levée en cas de timeout est une ",["$","strong",null,{"children":["$","code",null,{"children":"TransactionTimedOutException"}]}],". Cette exception est levée si la transaction ne se termine pas dans le délai imparti."]}],"\n",["$","p",null,{"children":"Voici notre exemple de pessimistic locking avec un timeout :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number highlight-line","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Transactional"}],["$","span",null,{"className":"token punctuation","children":"("}],"timeout ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token number","children":"10"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"void"}]," ",["$","span",null,{"className":"token function","children":"updateStockWithPessimisticLock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Long"}]," productId",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token keyword","children":"int"}]," quantityToAdd",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":["    ",["$","span",null,{"className":"token class-name","children":"Product"}]," product ",["$","span",null,{"className":"token operator","children":"="}]," productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findByIdWithLock"}],["$","span",null,{"className":"token punctuation","children":"("}],"productId",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":["            ",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"orElseThrow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"->"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"Produit non trouvé\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"6","children":["    product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getQuantity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"+"}]," quantityToAdd",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    productRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"save"}],["$","span",null,{"className":"token punctuation","children":"("}],"product",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"9","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"10","children":[["$","span",null,{"className":"token comment","children":"// Repository"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"12","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Repository"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"interface"}]," ",["$","span",null,{"className":"token class-name","children":"ProductRepository"}]," ",["$","span",null,{"className":"token keyword","children":"extends"}]," ",["$","span",null,{"className":"token class-name","children":"JpaRepository"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"Product"}],["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token class-name","children":"Long"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Lock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"LockModeType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"PESSIMISTIC_WRITE"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"15","children":["    ",["$","span",null,{"className":"token class-name","children":"Optional"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"Product"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token function","children":"findById"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Long"}]," productId",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"16","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"17","children":"\n"}]]}]}],"\n",["$","h2",null,{"children":"En savoir plus"}],"\n",["$","p",null,{"children":["Si vous souhaitez en savoir plus sur le pessimistic locking, vous pouvez consulter cet article : ",["$","a",null,{"href":"https://www.baeldung.com/jpa-pessimistic-locking","children":"https://www.baeldung.com/jpa-pessimistic-locking"}]]}],"\n",["$","h1",null,{"children":["$","a",null,{"id":"comment_gerer_des_transactions_dans_spring_boot","children":" Comment gérer des transactions dans Spring Boot ? "}]}],"\n",["$","h2",null,{"children":"Introduction"}],"\n",["$","p",null,{"children":"Les transactions sont un moyen de regrouper plusieurs opérations en une seule unité logique. Cela garantit que toutes les opérations sont exécutées de manière atomique, c'est-à-dire que toutes les opérations sont exécutées ou aucune opération n'est exécutée."}],"\n",["$","p",null,{"children":["Avec Spring Boot, vous pouvez gérer les transactions en utilisant l'annotation ",["$","strong",null,{"children":["$","code",null,{"children":"@Transactional"}]}],". Cette annotation permet de définir une méthode comme transactionnelle. Cela signifie que toutes les opérations sur la base de données effectuées dans cette méthode seront regroupées en une seule transaction."]}],"\n",["$","p",null,{"children":"Par exemple, si vous souhaitez ajouter une adresse à un utilisateur, vous devez ajouter l'adresse et mettre à jour l'utilisateur en même temps. Si l'une des opérations échoue, vous ne voulez pas que l'autre opération soit exécutée. Les transactions garantissent que les deux opérations sont exécutées ensemble."}],"\n",["$","p",null,{"children":"Les transactions ne règlent pas les problèmes de concurrence, mais couplé à l'optimistic ou pessimistic locking, elles permettent de gérer les conflits de manière plus robuste."}],"\n",["$","h2",null,{"children":"Bases pour les transactions"}],"\n",["$","p",null,{"children":"Voici un exemple de transaction en Java avec Spring Boot, lorsque nous avons un repository pour les utilisateurs et un repository pour les adresses."}],"\n",["$","p",null,{"children":"Voici les entités :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Entity"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"User"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Id"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@GeneratedValue"}],["$","span",null,{"className":"token punctuation","children":"("}],"strategy ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token class-name","children":"GenerationType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"IDENTITY"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," name",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"9","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@OneToOne"}],["$","span",null,{"className":"token punctuation","children":"("}],"cascade ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token class-name","children":"CascadeType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"ALL"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@JoinColumn"}],["$","span",null,{"className":"token punctuation","children":"("}],"name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"address_id\""}],["$","span",null,{"className":"token punctuation","children":","}]," referencedColumnName ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"id\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"Address"}]," address",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"13","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"15","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"16","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Entity"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"17","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"Address"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"18","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Id"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"19","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@GeneratedValue"}],["$","span",null,{"className":"token punctuation","children":"("}],"strategy ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token class-name","children":"GenerationType"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"IDENTITY"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"20","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"Long"}]," id",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"21","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"22","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Column"}],["$","span",null,{"className":"token punctuation","children":"("}],"unique ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"true"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token comment","children":"// Empêche les doublons d'adresses"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"23","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," street",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"24","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"25","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," city",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"26","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"27","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," postalCode",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"28","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"29","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"30","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Voici les repositories :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Repository"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"interface"}]," ",["$","span",null,{"className":"token class-name","children":"UserRepository"}]," ",["$","span",null,{"className":"token keyword","children":"extends"}]," ",["$","span",null,{"className":"token class-name","children":"JpaRepository"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"User"}],["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token class-name","children":"Long"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Voici les DTO pour les requêtes :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"UserDTO"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," name",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"AddressDTO"}]," address",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"7","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"8","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"AddressDTO"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"9","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," street",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," city",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token class-name","children":"String"}]," postalCode",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"13","children":["    ",["$","span",null,{"className":"token comment","children":"// Getters et setters"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Voici le contrôleur :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@RestController"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token annotation punctuation","children":"@RequestMapping"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"/users\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"UserController"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"4","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"final"}]," ",["$","span",null,{"className":"token class-name","children":"UserService"}]," userService",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"UserController"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"UserService"}]," userService",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":["        ",["$","span",null,{"className":"token keyword","children":"this"}],["$","span",null,{"className":"token punctuation","children":"."}],"userService ",["$","span",null,{"className":"token operator","children":"="}]," userService",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"9","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"11","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@PostMapping"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"User"}]," ",["$","span",null,{"className":"token function","children":"addUserWithAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token annotation punctuation","children":"@RequestBody"}]," ",["$","span",null,{"className":"token class-name","children":"UserDTO"}]," userDTO",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":["        ",["$","span",null,{"className":"token keyword","children":"return"}]," userService",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"addUserWithAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],"userDTO",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"15","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Voici l'exception que nous souhaitons lancer pour une adresse déjà existante :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-Java code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"AddressAlreadyExistsException"}]," ",["$","span",null,{"className":"token keyword","children":"extends"}]," ",["$","span",null,{"className":"token class-name","children":"RuntimeException"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"AddressAlreadyExistsException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"String"}]," message",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["        ",["$","span",null,{"className":"token keyword","children":"super"}],["$","span",null,{"className":"token punctuation","children":"("}],"message",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Voici un service pour ajouter une adresse et un utilisateur :"}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@Service"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"UserService"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"4","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"final"}]," ",["$","span",null,{"className":"token class-name","children":"UserRepository"}]," userRepository",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token keyword","children":"private"}]," ",["$","span",null,{"className":"token keyword","children":"final"}]," ",["$","span",null,{"className":"token class-name","children":"AddressRepository"}]," addressRepository",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"UserService"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"UserRepository"}]," userRepository",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token class-name","children":"AddressRepository"}]," addressRepository",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":["        ",["$","span",null,{"className":"token keyword","children":"this"}],["$","span",null,{"className":"token punctuation","children":"."}],"userRepository ",["$","span",null,{"className":"token operator","children":"="}]," userRepository",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"9","children":["        ",["$","span",null,{"className":"token keyword","children":"this"}],["$","span",null,{"className":"token punctuation","children":"."}],"addressRepository ",["$","span",null,{"className":"token operator","children":"="}]," addressRepository",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":"\n"}],["$","span",null,{"className":"code-line line-number highlight-line","line":"12","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@Transactional"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token class-name","children":"User"}]," ",["$","span",null,{"className":"token function","children":"addUserWithAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"UserDTO"}]," userDTO",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"14","children":["        ",["$","span",null,{"className":"token comment","children":"// Vérifier si l'adresse existe déjà"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"15","children":["        ",["$","span",null,{"className":"token class-name","children":"Optional"}],["$","span",null,{"className":"token generics","children":[["$","span",null,{"className":"token punctuation","children":"<"}],["$","span",null,{"className":"token class-name","children":"Address"}],["$","span",null,{"className":"token punctuation","children":">"}]]}]," existingAddress ",["$","span",null,{"className":"token operator","children":"="}]," addressRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"findByStreetAndCityAndPostalCode"}],["$","span",null,{"className":"token punctuation","children":"("}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"16","children":["                userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getStreet"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"17","children":["                userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getCity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"18","children":["                userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getPostalCode"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"19","children":["        ",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"20","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"21","children":["        ",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"existingAddress",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"isPresent"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"22","children":["            ",["$","span",null,{"className":"token keyword","children":"throw"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"AddressAlreadyExistsException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"L'adresse existe déjà !\""}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"23","children":["        ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"24","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"25","children":["        ",["$","span",null,{"className":"token comment","children":"// Sauvegarder l'adresse"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"26","children":["        ",["$","span",null,{"className":"token class-name","children":"Address"}]," address ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"Address"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"27","children":["        address",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setStreet"}],["$","span",null,{"className":"token punctuation","children":"("}],"userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getStreet"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"28","children":["        address",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setCity"}],["$","span",null,{"className":"token punctuation","children":"("}],"userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getCity"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"29","children":["        address",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setPostalCode"}],["$","span",null,{"className":"token punctuation","children":"("}],"userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getPostalCode"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"30","children":["        addressRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"save"}],["$","span",null,{"className":"token punctuation","children":"("}],"address",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"31","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"32","children":["        ",["$","span",null,{"className":"token comment","children":"// Sauvegarder l'utilisateur"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"33","children":["        ",["$","span",null,{"className":"token class-name","children":"User"}]," user ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"User"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"34","children":["        user",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setName"}],["$","span",null,{"className":"token punctuation","children":"("}],"userDTO",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getName"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"35","children":["        user",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"setAddress"}],["$","span",null,{"className":"token punctuation","children":"("}],"address",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"36","children":["        ",["$","span",null,{"className":"token keyword","children":"return"}]," userRepository",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"save"}],["$","span",null,{"className":"token punctuation","children":"("}],"user",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token comment","children":"// Retourner l'utilisateur sauvegardé"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"37","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"38","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","blockquote",null,{"children":["\n",["$","p",null,{"children":["Ici la gestion des transactions est assurée par l'annotation ",["$","strong",null,{"children":["$","code",null,{"children":"@Transactional"}]}]," sur la méthode ",["$","strong",null,{"children":["$","code",null,{"children":"addUserWithAddress"}]}],". Cela signifie que toutes les opérations effectuées dans cette méthode seront regroupées en une seule transaction. Cela garantit que toutes les opérations sont exécutées de manière atomique, c'est-à-dire que toutes les opérations sont exécutées ou aucune opération n'est exécutée."]}],"\n"]}],"\n",["$","p",null,{"children":["💭 Peux-tu imaginer une autre raison pour que JPA échoue à sauvegarder l'adresse ?",["$","br",null,{}],"\n","Normalement, JPA ne devrait pas échouer à sauvegarder l'adresse, car normalement, dans le contrôleur, on est censé valider tous les paramètres avant d'appeler le service."]}],"\n",["$","p",null,{"children":["Une fois l'adresse sauvegardée, on pourrait imaginer que l'on ne peut pas sauvegarder l'utilisateur. Par exemple, si l'utilisateur a déjà été sauvegardé, on ne peut pas le sauvegarder à nouveau.",["$","br",null,{}],"\n","L'avantage de la transaction est que si l'une des opérations échoue, l'autre opération ne sera pas exécutée. Cela garantit que les données restent cohérentes.",["$","br",null,{}],"\n","Bien sûr, pour rendre le code plus robuste et clair, il faudrait aussi vérifier si l'utilisateur existe déjà avant de le sauvegarder."]}],"\n",["$","p",null,{"children":"💭 Est-ce qu'il faudrait mettre en place du locking ici, est-ce que la transaction est suffisante"}],"\n",["$","p",null,{"children":["Et finalement, voici le gestionnaire global d'exceptions pour l'exception ",["$","strong",null,{"children":["$","code",null,{"children":"AddressAlreadyExistsException"}]}]," :"]}],"\n",["$","pre",null,{"className":"language-java","children":["$","code",null,{"className":"language-java code-highlight","children":[["$","span",null,{"className":"code-line line-number","line":"1","children":[["$","span",null,{"className":"token annotation punctuation","children":"@ControllerAdvice"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"2","children":[["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"class"}]," ",["$","span",null,{"className":"token class-name","children":"GlobalExceptionHandler"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"3","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"4","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@ExceptionHandler"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"AddressAlreadyExistsException"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token keyword","children":"class"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"5","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"void"}]," ",["$","span",null,{"className":"token function","children":"handleAddressAlreadyExistsException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"AddressAlreadyExistsException"}]," ex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"6","children":["        ",["$","span",null,{"className":"token keyword","children":"throw"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"ResponseStatusException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"HttpStatus"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"CONFLICT"}],["$","span",null,{"className":"token punctuation","children":","}]," ex",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getMessage"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"7","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"8","children":"\n"}],["$","span",null,{"className":"code-line line-number","line":"9","children":["    ",["$","span",null,{"className":"token annotation punctuation","children":"@ExceptionHandler"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Exception"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token keyword","children":"class"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"10","children":["    ",["$","span",null,{"className":"token keyword","children":"public"}]," ",["$","span",null,{"className":"token keyword","children":"void"}]," ",["$","span",null,{"className":"token function","children":"handleGenericException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"Exception"}]," ex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"11","children":["        ",["$","span",null,{"className":"token keyword","children":"throw"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"ResponseStatusException"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token class-name","children":"HttpStatus"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token constant","children":"INTERNAL_SERVER_ERROR"}],["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token string","children":"\"Une erreur est survenue : \""}]," ",["$","span",null,{"className":"token operator","children":"+"}]," ex",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"getMessage"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"12","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line line-number","line":"13","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["Ici, le gestionnaire global d'exceptions renvoie une réponse ",["$","strong",null,{"children":["$","code",null,{"children":"409 Conflict"}]}]," au client en cas d'exception ",["$","strong",null,{"children":["$","code",null,{"children":"AddressAlreadyExistsException"}]}],". Cela signifie que si l'adresse existe déjà, le client recevra une réponse ",["$","strong",null,{"children":["$","code",null,{"children":"409 Conflict"}]}],"."]}],"\n",["$","h2",null,{"children":"En savoir plus"}],"\n",["$","p",null,{"children":["Si vous souhaitez en savoir plus sur les transactions avec Spring Boot, vous pouvez consulter cet article : ",["$","a",null,{"href":"https://docs.spring.io/spring-framework/reference/data-access/transaction.html","children":"https://docs.spring.io/spring-framework/reference/data-access/transaction.html"}]]}]]
f:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
d:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Concurrence"}]]
b:null
