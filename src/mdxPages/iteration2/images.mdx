---
title: Images
description: Gestion des images
date: 24/02/2025
---

<InternalPageMenu>
  <PathViewer>
    <PathViewerItem to="/"> CAE </PathViewerItem>
    <PathViewerItem to="/iteration2"> It√©ration 2 </PathViewerItem>
    <PathViewerItem selected> Gestion des images </PathViewerItem>
  </PathViewer>
  <InternalPageMenuItem> Comment g√©rer des assets ? </InternalPageMenuItem>
  <InternalPageMenuItem> Comment fonctionne un service de stockage d'objets ? </InternalPageMenuItem>
  <InternalPageMenuItem> Comment cr√©er un service de stockage sur Azure ? </InternalPageMenuItem>
  <InternalPageMenuItem> TBC </InternalPageMenuItem>
  <InternalPageMenuItem> TBC </InternalPageMenuItem>
  <InternalPageMenuItem> TBC </InternalPageMenuItem>
  <InternalPageMenuItem> TBC </InternalPageMenuItem>
    <InternalPageMenuItem> TBC </InternalPageMenuItem>
    <InternalPageMenuItem> TBC </InternalPageMenuItem>
  <InternalPageMenuItem> TBC </InternalPageMenuItem>
  <InternalPageMenuItem> TBC </InternalPageMenuItem>
</InternalPageMenu>

# <InternalPageTitle> Comment g√©rer des assets ? </InternalPageTitle>

## Introduction

Les assets sont des ressources statiques (images, vid√©os, fichiers de styles, etc.) qui sont utilis√©es dans une application. 

Il existe diff√©rents moyens de mettre √† disposition ces ressources pour une application web. Voici les moyens les plus courants :
- **Importer les assets dans le code source du frontend** : Les assets sont import√©s dans le code source de l'application. Cela peut √™tre fait en utilisant des imports dans le code source (ex: `import image from './image.png'`) ou en fournissant un chemin relatif vers l'asset qui se trouve dans le r√©pertoire **`public`** (ex: `<img src="/image.png" />`).
- **H√©berger les assets via un serveur de fichiers statiques associ√© √† l'API** : Les assets sont stock√©s dans un serveur de fichiers statiques mis √† disposition par l'API. L'API fournit alors des URLs pour acc√©der aux assets.
- **Offrir des op√©rations de l'API d√©di√©es √† la gestion des assets** : L'API expose des op√©rations d√©di√©es √† la gestion des assets (ex: create, read, delete). Ces op√©rations permettent de stocker et de r√©cup√©rer les assets de mani√®re s√©curis√©e. L'API peut stocker les assets :
  - dans un syst√®me de fichiers ;
  - dans une base de donn√©es.
- **Utiliser un service tiers de gestion des assets** : Un service tiers sp√©cialis√© dans la gestion des assets est utilis√© pour stocker et g√©rer les assets. Un exemple de service tiers est **placid**.
- **H√©berger les assets dans un service de stockage d'objets** : Les assets sont stock√©s dans un service de stockage d'objets (ex: AWS S3, Google Cloud Storage). L'API fournit alors des URLs pour acc√©der aux assets.

Nous allons explorer ces diff√©rentes approches dans les sections suivantes.

## Importer les assets dans le code source du frontend

L'import des assets dans le code source du frontend est une approche simple et courante pour g√©rer les images dans une application web. 

Cela fonctionne lorsque nous avons un nombre limit√© d'images et que ces images ne changent pas fr√©quemment.

Bien entendu, cette approche ne fonctionne que pour des images pr√©d√©finies, utiles lorsque l'on souhaite afficher des images de logo, des ic√¥nes, des images de produits par d√©faut, etc.

Si l'on souhaite permettre aux utilisateurs de t√©l√©charger des images, cette approche n'est pas adapt√©e.

Cette approche pourra √™tre utilis√©e dans le projet CAE pour les images de logo, les ic√¥nes, etc. Pour les fichiers dynamiques, nous utiliserons une autre approche.

## H√©berger les assets via un serveur de fichiers statiques associ√© √† l'API

L'h√©bergement des assets via un serveur de fichiers statiques associ√© √† l'API est une approche courante pour stocker des assets dans une application web.

Dans cette approche, les assets sont stock√©es dans un r√©pertoire d√©di√© du serveur de fichiers statiques. L'API expose alors des URLs pour acc√©der aux assets.

Cette approche est principalement utile pour des assets qui sont statiques. Si l'on souhaite stocker des assets dynamiquement (ex: t√©l√©chargement d'images par les utilisateurs), il va falloir cr√©er des op√©rations d√©di√©es (cas suivant) dans l'API pour g√©rer ces assets.

Les inconv√©nients de cette approche sont les suivants :
- Les assets sont stock√©es sur le m√™me serveur que l'API, ce qui peut entra√Æner une surcharge du serveur si le nombre d'assets est important.
- Les URLs des assets sont directement accessibles, ce qui peut poser des probl√®mes de s√©curit√© (ex: acc√®s non autoris√© aux images).
- Si l'on doit d'office **Offrir des op√©rations de l'API d√©di√©es √† la gestion des assets** (voir le cas suivant), alors autant jouer la carte de la s√©curit√© et ne pas utiliser d'URLs directes pour les assets.

Nous n'allons donc pas utiliser cette approche dans notre projet CAE.


## Offrir des op√©rations de l'API d√©di√©es √† la gestion des assets

Offrir des op√©rations de l'API d√©di√©es √† la gestion des assets est une approche plus s√©curis√©e pour stocker et g√©rer les assets dans une application web.

Dans cette approche, l'API expose des op√©rations d√©di√©es pour stocker, r√©cup√©rer et supprimer des assets. Les assets peuvent √™tre stock√©es dans un syst√®me de fichiers ou dans une base de donn√©es.

Cette approche est particuli√®rement utile lorsque l'on souhaite stocker des assets dynamiquement (ex: t√©l√©chargement d'images par les utilisateurs).

G√©n√©ralement, on va stocker les assets dans un r√©pertoire d√©di√© du serveur de l'API. L'API va alors g√©rer les op√©rations de stockage, de r√©cup√©ration et de suppression des assets. 
L'avantage de cette approche est que l'on peut contr√¥ler l'acc√®s aux assets et garantir leur s√©curit√©.

On utilise moins souvent une base de donn√©es pour stocker les assets, pour ces raisons :
- Les bases de donn√©es ne sont pas optimis√©es pour stocker des fichiers binaires (ex: images), les op√©rations de lecture et d'√©criture peuvent √™tre plus lentes.
- Le stockage en DB co√ªte cher !
- Un asset enregistr√© dans une base de donn√©es prend plus de place qu'un fichier stock√© sur le disque (passage en base64 et overhead pour la gestion des enregistrements, des index et des m√©tadonn√©es). Quel pourcentage ? Cela d√©pend de la taille des fichiers et de la base de donn√©es utilis√©e, mais on peut estimer cela √† environ 30-40%.
- Les bases de donn√©es peuvent devenir rapidement surcharg√©es si l'on stocke des fichiers binaires.

Les inconv√©nients de cette approche, d'offrir des op√©rations de l'API √† la gestion des assets, sont les suivants :
- La complexit√© de la gestion des op√©rations de stockage, de r√©cup√©ration et de suppression des assets. Il faut g√©rer les autorisations, les contr√¥les d'acc√®s, les quotas de stockage, etc.
- La surcharge du serveur de l'API si le nombre d'assets est important.

Nous n'allons donc pas utiliser cette approche dans notre projet CAE.

## Utiliser un service tiers de gestion des assets

Utiliser un service tiers de gestion des assets est une approche int√©ressante pour stocker et g√©rer les assets dans une application web.

Un service tiers sp√©cialis√© dans la gestion des assets offre g√©n√©ralement des fonctionnalit√©s avanc√©es pour stocker, r√©cup√©rer et supprimer des assets. Ces services sont souvent optimis√©s pour g√©rer des fichiers binaires (ex: images, vid√©os, fichiers audio...).

Un exemple de service tiers de gestion des assets est **placid**. Placid permet de stocker des images et de les manipuler (redimensionner, recadrer, compresser, etc.) via une API.

Les avantages de cette approche sont les suivants :
- Les services tiers de gestion des assets offrent des fonctionnalit√©s avanc√©es pour manipuler les assets (ex: redimensionner, recadrer, compresser).
- Les services tiers de gestion des assets sont souvent optimis√©s pour g√©rer des fichiers binaires.
- Les services tiers de gestion des assets offrent g√©n√©ralement des fonctionnalit√©s de s√©curit√© avanc√©es (ex: contr√¥le d'acc√®s, chiffrement).

Les inconv√©nients de cette approche sont les suivants :
- Les services tiers de gestion des assets peuvent √™tre co√ªteux.
- Les services tiers de gestion des assets peuvent √™tre moins flexibles que des solutions auto-h√©berg√©es.
- Il faut souvent utiliser un cl√© d'API pour acc√©der aux services tiers de gestion des assets, ce qui peut poser des probl√®mes de s√©curit√©. Il faut alors bien prot√©ger cette cl√© d'API et donc cr√©er ses propres op√©rations de l'API pour g√©rer les acc√®s √† ces services tiers. On retombe alors sur le cas pr√©c√©dent (**Offrir des op√©rations de l'API d√©di√©es √† la gestion des assets** !).

Nous n'allons donc pas utiliser cette approche dans notre projet CAE.

## H√©berger les assets dans un service de stockage d'objets

H√©berger les assets dans un service de stockage d'objets est une approche courante pour stocker des assets dans une application web.

Les services de stockage d'objets (ex: Azure Stockage, AWS S3, Google Cloud Storage) sont optimis√©s pour stocker des fichiers binaires (ex: images, vid√©os, fichiers audio...). Ils offrent des fonctionnalit√©s avanc√©es pour stocker, r√©cup√©rer et supprimer des assets. G√©n√©ralement, leur tarification est bas√©e sur l'utilisation (ex: quantit√© de donn√©es stock√©es, quantit√© de donn√©es transf√©r√©es) et sont donc tr√®s comp√©titifs.

De plus, les services de stockage d'objets offrent des fonctionnalit√©s de s√©curit√© avanc√©es (ex: contr√¥le d'acc√®s, chiffrement).

Voici les gros avantages de cette approche :
- On peut d√©l√©guer la gestion des assets √† un service tiers sp√©cialis√©, ce qui permet de se concentrer sur le d√©veloppement de l'application.
- Les services de stockage d'objets sont optimis√©s pour stocker des fichiers binaires et offrent des fonctionnalit√©s avanc√©es pour manipuler les assets.
- Les services de stockage d'objets offrent des fonctionnalit√©s de s√©curit√© avanc√©es (ex: contr√¥le d'acc√®s, chiffrement) qui ne demande pas de gros efforts au niveau de ses propres op√©rations de l'API. Il y a toujours des efforts √† faire lors de l'upload de fichiers, mais ils sont moindres. Nous allons les voir dans la section suivante.
- Pour la lecture de fichiers, il est possible que le frontend acc√®de directement aux URLs des assets, sans passer par l'API, tout en assurant la s√©curit√© des fichiers. Cela peut √™tre un avantage en termes de performance.
- Les services de stockage d'objets sont g√©n√©ralement tr√®s comp√©titifs en termes de tarification.

Nous allons donc utiliser cette approche dans notre projet CAE.

# <InternalPageTitle> Comment fonctionne un service de stockage d'objets ? </InternalPageTitle>

## Introduction

Un service de stockage d'objets est un service cloud qui permet de stocker des fichiers binaires (ex: images, vid√©os, fichiers audio...) de mani√®re s√©curis√©e et scalable.

Les services de stockage d'objets sont optimis√©s pour stocker de gros volumes de donn√©es non structur√©es. Ils offrent des fonctionnalit√©s avanc√©es pour stocker, r√©cup√©rer et supprimer des objets.

Les services de stockage d'objets sont g√©n√©ralement bas√©s sur une architecture de stockage distribu√©. Les donn√©es sont r√©pliqu√©es sur plusieurs serveurs pour garantir la disponibilit√© et la durabilit√© des donn√©es.

## Comment assurer la s√©curit√© des fichiers stock√©s ?

Pour assurer la s√©curit√© des fichiers stock√©s dans un service de stockage d'objets, voici quelques bonnes pratiques √† suivre :
- **Chiffrement des donn√©es au repos** ("Encryption at Rest"): Les donn√©es stock√©es dans le service de stockage d'objets doivent √™tre chiffr√©es pour garantir leur confidentialit√©. Les services de stockage d'objets offrent g√©n√©ralement des fonctionnalit√©s de chiffrement des donn√©es au repos. Par exemple, Azure Storage chiffre automatiquement les donn√©es au repos (chiffrement appliqu√© √† tous les objets stock√©s dans Azure Blob Storage, Azure Files, Azure Queue Storage et Azure Table Storage) √† l'aide de cl√©s de chiffrement g√©r√©es par le service.
- **Contr√¥le d'acc√®s bas√© sur les r√¥les** : Les acc√®s aux fichiers stock√©s dans le service de stockage d'objets doivent √™tre contr√¥l√©s en fonction des r√¥les des utilisateurs. Dans Azure Storage, on peut utiliser les **SAS (Shared Access Signatures)** pour d√©finir des autorisations granulaires sur les objets stock√©s.
- **Journalisation des acc√®s** : Les acc√®s aux fichiers stock√©s dans le service de stockage d'objets doivent √™tre journalis√©s pour permettre la tra√ßabilit√© des acc√®s. Les services de stockage d'objets offrent g√©n√©ralement des fonctionnalit√©s de journalisation des acc√®s.
- **Gestion des cl√©s d'API** : Les cl√©s d'API utilis√©es pour acc√©der au service de stockage d'objets doivent √™tre g√©r√©es de mani√®re s√©curis√©e. Azure Storage permet de g√©rer les cl√©s d'API √† l'aide de l'Azure Key Vault.

## Comment g√©rer les op√©rations CRUD sur les fichiers ?

Pour g√©rer les op√©rations CRUD (Create, Read, Update, Delete) sur les fichiers stock√©s dans un service de stockage d'objets, voici quelques bonnes pratiques √† suivre :
- **Utilisation d'une API RESTful** : Les op√©rations CRUD sur les fichiers stock√©s dans le service de stockage d'objets doivent √™tre expos√©es via une API RESTful. Les services de stockage d'objets offrent g√©n√©ralement des SDK pour faciliter l'int√©gration avec l'API. Par exemple, Azure Storage propose des SDK pour diff√©rentes langages de programmation (C#, Java, Python, Node.js, etc.).
Il existe un **`BlobClientBuilder`** pour manipuler les blobs dans Azure Storage.
- **Gestion des m√©tadonn√©es** : Les fichiers stock√©s dans le service de stockage d'objets peuvent √™tre associ√©s √† des m√©tadonn√©es pour faciliter leur gestion. Les m√©tadonn√©es peuvent √™tre utilis√©es pour stocker des informations suppl√©mentaires sur les fichiers (ex: type de contenu, taille, date de cr√©ation, etc.).
- **Gestion des autorisations** : Les acc√®s aux fichiers stock√©s dans le service de stockage d'objets doivent √™tre contr√¥l√©s en fonction des autorisations des utilisateurs. Dans Azure Storage, on peut utiliser les **SAS (Shared Access Signatures)** pour d√©finir des autorisations granulaires sur les objets stock√©s. Une SAS est un jeton qui peut √™tre ajout√© √† une URL pour accorder un acc√®s temporaire et limit√© √† une ressource dans Azure Storage. La SAS sp√©cifie les permissions (lecture, √©criture, suppression, etc.), la dur√©e de validit√© et d'autres restrictions d'acc√®s.
- **Gestion des versions** : Les fichiers stock√©s dans le service de stockage d'objets peuvent √™tre versionn√©s pour permettre la gestion des versions des fichiers. Les services de stockage d'objets offrent g√©n√©ralement des fonctionnalit√©s de gestion des versions.
Azure Storage propose la gestion des versions pour les blobs.

## Est-il possible de ne pas s√©curiser l'acc√®s aux fichiers ?

Il est possible de ne pas s√©curiser l'acc√®s aux fichiers stock√©s dans un service de stockage d'objets, mais cela pose des risques en termes de s√©curit√©. Les fichiers stock√©s dans le service de stockage d'objets peuvent contenir des informations sensibles (ex: donn√©es personnelles, propri√©t√© intellectuelle, etc.) qui doivent √™tre prot√©g√©es.

Si √ßa n'est pas le cas, alors il est possible de ne pas s√©curiser l'acc√®s aux fichiers stock√©s dans le service de stockage d'objets. Cela peut √™tre utile pour des fichiers publics (ex: images, vid√©os, fichiers audio accessibles au public).

Attention que m√™me si l'on n'utilise pas des autorisations pour la lecture des fichiers, il est possible de trouver un compromis au niveau s√©curit√© de cette fa√ßon :
- **Cr√©ation de noms de fichiers complexes** : Les noms de fichiers stock√©s dans le service de stockage d'objets peuvent √™tre rendus complexes pour limiter l'acc√®s non autoris√©. Par exemple, on peut utiliser des UUID (Universal Unique Identifier) comme noms de fichiers.
- **Rendre l'acc√®s public en lecture seule et individuelle aux fichiers** (et pas au niveau du conteneur) : Ainsi il n'est pas possible de lister les fichiers, mais on peut acc√©der √† un fichier seulement si on conna√Æt son URL.

Avec ce compromis, on peut limiter l'acc√®s non autoris√© aux fichiers stock√©s dans le service de stockage d'objets tout en permettant un acc√®s public aux fichiers.

Nous allons utiliser ce compromis pour le projet CAE.

Attention que pour la cr√©ation et l'effacement de fichier, il est toujours n√©cessaire de s√©curiser l'acc√®s ! Sinon, n'importe qui pourrait cr√©er ou effacer des fichiers dans le service de stockage d'objets üò± ! 

Ainsi, nous utiliserons un SAS token pour les op√©ration de cr√©ation et d'effacement de fichiers.

## Comment autoriser l'acc√®s aux fichiers stock√©s dans le service de stockage avec Azure Stockage ?

Pour autoriser l'acc√®s aux fichiers stock√©s dans le service de stockage avec Azure Stockage, on peut utiliser les **SAS (Shared Access Signatures)**.

Une SAS est un jeton qui peut √™tre ajout√© √† une URL pour accorder un acc√®s temporaire et limit√© √† une ressource dans Azure Storage. La SAS sp√©cifie les permissions (lecture, √©criture, suppression, etc.), la dur√©e de validit√© et d'autres restrictions d'acc√®s. 

Une URL SAS est une URL qui inclut une SAS, permettant aux utilisateur ou une application d'acc√©der √† une ressource sp√©cifique dans Azure Storage sans avoir besoin des cl√©s d'acc√®s principales du compte de stockage.

Voici le workflow que nous utiliserons pour autoriser l'acc√®s aux fichiers stock√©s dans le service de stockage avec Azure Stockage :

<PlantUML src="/diagrams/azure-storage.puml" alt="Gestion d'images pour le projet avec Azure Stockage" />

Dans un premier temps, les d√©veloppeurs vont devoir g√©n√©rer une token (SAS) pour les fichiers stock√©s dans le service de stockage. Cette SAS va sp√©cifier les permissions (lecture, √©criture, suppression, etc.), la dur√©e de validit√© et d'autres restrictions d'acc√®s.

Puis, lorsque l'application est ex√©cut√©e, le frontend permettra via un formulaire de cr√©er des ressources incluant une image. Lors de la cr√©ation de la ressource, le frontend va envoyer une requ√™te √† l'API avec l'image √† stocker. 
En utilisant le token (SAS), l'API va pouvoir stocker l'image dans le service de stockage d'objets.

Finalement, lorsque les utilisateurs consulteront une page affichant les ressources, le frontend va envoyer une requ√™te √† l'API pour r√©cup√©rer les ressources √† afficher. L'API va alors r√©cup√©rer les ressources stock√©es dans la DB, incluant l'URL vers l'image stock√©e dans le service de stockage d'objets. Le frontend va alors afficher les ressources, incluant les images stock√©es dans le service de stockage d'objets. 
NB : si l'on avait souhait√© s√©curiser au maximum les images, on aurait pu passer par l'API pour qu'elle sauvegarde une SAS URL pour chaque image stock√©e dans le service de stockage d'objets. Cela aurait permis de contr√¥ler l'acc√®s lors de la lecture des images. Mais pour notre projet, nous avons choisi d'avoir un compromis au niveau s√©curit√©.

# <InternalPageTitle> Comment cr√©er un service de stockage sur Azure ? </InternalPageTitle>

## Introduction

Comme vous le savez d√©j√†, Azure Storage est un service cloud de stockage d'objets qui permet de stocker des fichiers binaires (ex: images, vid√©os, fichiers audio...) de mani√®re s√©curis√©e et scalable. 

Nous allons √† pr√©sent voir comment appliquer le workflow que nous avons vu pr√©c√©demment pour sauvegarder des images dans Azure Storage au sein d'une application existante permettant de cr√©er et afficher des pizzas.

Le point de d√©part pour ce tutoriel est le site de gestion de la pizzeria comme vu au dernier tutoriel nomm√© [staging](https://github.com/e-vinci/cae-theory-demos/tree/main/staging). Veuillez donc en faire une copie au sein d'un projet GitLab.

## Cr√©ation d'un compte de stockage Azure (Storage account)

Pour cr√©er un compte de stockage Azure, vous devez disposer d'un abonnement Azure depuis moins de 12 mois. Si vous √™tes √©tudiant, vous pouvez b√©n√©ficier d'un abonnement gratuit Azure for Students.

Veuillez suivre les √©tapes suivantes pour cr√©er un compte de stockage Azure :
- Connectez-vous √† votre [portail Azure](https://portal.azure.com/).
- Dans la recherche, tapez **`Free services`**, puis cliquez sur **`Free services`**.
- S√©lectionnez ensuite **`Azure Blob Storage`** (`5 GB locally redundant storage (LRS) hot block with 20,000 read and 10,000 write operations`), puis cliquez sur **`Create`**.
- S√©lectionnez votre **`Subscription`** et **`Resource group`**. Pour les √©tudiants Vinci, cela devrait √™tre **`Azure for Students`**. Si vous n'avez pas de **`Resource group`**, vous pouvez en cr√©er un en cliquant sur **`Create new`** (**`imageGroup`** par exemple).
- Entrez un **`Storage account name`** unique. Par exemple : **`imagestorage007`**.
- S√©lectionnez la **`Region`** qui est acceptable dans un plan gratuit. Par exemple : **`West Europe`**.
- Cliquez sur **`Review + create`**, puis sur **`Create`**.
- Attendez que le d√©ploiement soit termin√©. Cela peut prendre quelques minutes. Puis cliquez sur **`Go to resource`**.

## Cr√©ation de deux blobs containers

### Introduction 

Un blob container est un conteneur de stockage d'objets dans Azure Storage. Il est utilis√© pour stocker des objets binaires (ex: images, vid√©os, fichiers audio...).

Nous souhaitions cr√©er deux blob containers pour stocker les images des pizzas :
- un container pour l'environnement de d√©veloppement (**`dev`**)
- un container pour l'environnement de staging (**`staging`**)

### Configuration du storage account

Dans un premier temps, il faut s'assurer qu'on aie le droit d'acc√©der de mani√®re anonyme aux blobs. 

Voici comment faire :
- Dans le portail Azure, cliquez sur **`Storage accounts`** dans le menu de gauche.
- Cliquez sur le **`Storage account`** que vous avez cr√©√© pr√©c√©demment (**`imagestorage007`** par exemple).
- Cliquez dans **`Settings`** sur **`Configuration`**.
- **`Allow Blob anonymous access`** doit √™tre √† **`Enabled`**.

### Cr√©ation du blob container pour l'environnement de d√©veloppement

Pour cr√©er un blob container pour l'environnement de d√©veloppement, veuillez suivre les √©tapes suivantes :
- Dans le portail Azure, cliquez sur **`Storage accounts`** dans le menu de gauche.
- Cliquez sur le **`Storage account`** que vous avez cr√©√© pr√©c√©demment (**`imagestorage007`** par exemple).
- Dans le menu de gauche, sous **`Data storage`**, cliquez sur **`Containers`**.
- Cliquez sur **`+ Container`**.
- Entrez un nom pour le container. Par exemple : **`dev`**.
- Pour **`Anonymous access level`**, s√©lectionnez **`Blob (anonymous read access for blobs only)`**. Gr√¢ce √† cela, les blobs peuvent √™tre lus par n'importe qui, mais sans avoir le droit de lister les blobs.
- Laissez les autres param√®tres par d√©faut.
- Cliquez sur **`Create`**.

### Cr√©ation du blob container pour l'environnement de staging

Pour cr√©er un blob container pour l'environnement de staging, veuillez suivre les √©tapes suivantes :
- Dans le portail Azure, cliquez sur **`Storage accounts`** dans le menu de gauche.
- Cliquez sur le **`Storage account`** que vous avez cr√©√© pr√©c√©demment (**`imagestorage007`** par exemple).
- Dans le menu de gauche, sous **`Data storage`**, cliquez sur **`Containers`**.
- Cliquez sur **`+ Container`**.
- Entrez un nom pour le container. Par exemple : **`staging`**.
- Laissez les autres param√®tres par d√©faut.
- Cliquez sur **`Create`**.

### S√©curisation des acc√®s via un SAS token

Pour s√©curiser les acc√®s aux blobs, nous allons utiliser un SAS token.
Nous allons g√©n√©rer un SAS token pour tous les blobs de notre storage account. Ce SAS token doit permettre la cr√©ation et la suppression de blobs.

Voici comment faire :
- Dans le portail Azure, cliquez sur **`Storage accounts`** dans le menu de gauche.
- Cliquez sur le **`Storage account`** que vous avez cr√©√© pr√©c√©demment (**`imagestorage007`** par exemple).
- Dans le menu de gauche, sous **`Security + networking`**, cliquez sur **`Shared access signature`**.
- Dans **`Allowed resources types`**, s√©lectionnez **`Object`**. Un **`Object`** fait r√©f√©rence √† une unit√© de donn√©es stock√©e dans Azure Storage, comme un blob.
- Dans **`Allowed permissions`**, m√™me si c'est juste  **`Create`** et **`Delete`** que nous avons besoin, nous allons laisser toutes les permissions s√©lectionn√©es.
- Pour le **`Start time`**, laissez la date actuelle.
- Pour le **`End time`**, s√©lectionnez une date loin dans le futur. Par exemple, 10 ans plus tard.
- Cliquez sur **`Generate SAS and connection string`**.
- Veuillez conserver :
  - le **`SAS token`** g√©n√©r√©, comme par exemple **`sv=2024-11-02&ss=bfqt&srt=o&sp=rwdlacaerpiytfx&se=2035-02-24T23:52:15Z&st=2025-02-24T15:52:15Z&spr=https&sig=OoOvYhdQZFxO79sqdfqsHXHgDw1cCvq%2FeSciIift10CTT54%3D`**.
  - le **`Blob endpoint`** g√©n√©r√©, comme par exemple : **`https://imagestorage007.blob.core.windows.net/`**.


# <InternalPageTitle> Comment utiliser le service de stockage via l'API ? </InternalPageTitle>

## Introduction

Maintenant que nous avons cr√©√© un service de stockage d'objets sur Azure, nous allons voir comment l'utiliser via l'API pour stocker et r√©cup√©rer des images.

Dans notre tutoriel, nous allons modifier le service de gestion des pizzas pour qu'il utilise le service de stockage d'objets pour stocker les images des pizzas :
- lors de la cr√©ation d'une pizza : l'image de la pizza sera stock√©e dans le service de stockage d'objets ;
- lors de la r√©cup√©ration des pizzas : l'URL de l'image de la pizza sera r√©cup√©r√©e depuis la DB.
- lors de la suppression d'une pizza : l'image de la pizza sera supprim√©e du service de stockage d'objets.

## Configuration de l'API pour utiliser le service de stockage

### Introduction

L'API a besoin de conna√Ætre les informations suivantes pour utiliser le service de stockage d'objets :
- le **`Blob endpoint`** : l'URL de base du service de stockage d'objets (ex: **`https://imagestorage007.blob.core.windows.net/`**).
- le **`SAS token`** : le token d'acc√®s partag√© pour acc√©der au service de stockage d'objets (ex: **`sv=2024-11-02&ss=bfqt&srt=o&sp=rwdlacaerpiytfx&se=2035-02-24T23:52:15Z&st=2025-02-24T15:52:15Z&spr=https&sig=OoOvYhdQZFxO79sqdfqsHXHgDw1cCvq%2FeSciIift10CTT54%3D`**).
- le **`Container name`** : le nom du blob container dans lequel les images seront stock√©es (ex: **`dev`**).

### Configuration de l'API pour l'environnement de d√©veloppement

Pour configurer l'API pour l'environnement de d√©veloppement, actuellement, nous utilisons **`application.properties`** pour stocker les configurations. Nous allons ajouter les configurations suivantes :
```properties
azure.blob.service-endpoint=https://imagestorage007.blob.core.windows.net/
azure.blob.container-name=dev
azure.blob.sas-token=${AZURE_BLOB_SAS_TOKEN}

spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB
```

Voici quelques explications sur ces configurations :
- **`azure.blob.service-endpoint`** : l'URL de base du service de stockage d'objets (ex: **`https://imagestorage007.blob.core.windows.net/`**). 
- **`azure.blob.container-name`** : le nom du blob container dans lequel les images seront stock√©es (ex: **`dev`**).
- **`azure.blob.sas-token`** : le token d'acc√®s partag√© pour acc√©der au service de stockage d'objets (ex: **`${AZURE_BLOB_SAS_TOKEN}`**). Nous allons stocker ce token dans une variable d'environnement car c'est un secret qui ne doit pas se trouver dans le code source.
- **`spring.servlet.multipart.enabled`** : active le support de l'upload de fichiers. **`multipart`** signifie que le contenu de la requ√™te est un formulaire multipart, c'est √† dire qu'il contient des donn√©es de plusieurs types (texte / json, fichier, etc.).
- **`spring.servlet.multipart.max-file-size`** : la taille maximale autoris√©e pour un fichier.
- **`spring.servlet.multipart.max-request-size`** : la taille maximale autoris√©e pour une requ√™te.  

Au sein du fichier **`/api/.env`**, nous allons ajouter la propri√©t√© **`AZURE_BLOB_SAS_TOKEN`** avec la valeur du SAS token que vous avez not√© pr√©c√©demment. Voici un exemple :
```properties
AZURE_BLOB_SAS_TOKEN=sv=2024-11-02&ss=bfqt&srt=o&sp=rwdlacaerpiytfx&se=2035-02-24T23:52:15Z&st=2025-02-24T15:52:15Z&spr=https&sig=OoOvYhdQZFxO79sqhhqsHXHgDw1cbvq%2FeSciIift10XRT74%3D
```

Pour rappel, lorsque nous utiliserons IntelliJ pour lancer l'API, comme nous avons install√© la d√©pendance **`spring-dotenv`**, les variables d'environnement stock√©es dans le fichier **`/api/.env`** seront automatiquement charg√©es.

### 







